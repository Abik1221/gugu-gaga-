{"version":3,"sources":["turbopack:///[project]/app/(dashboard)/dashboard/owner/chat/[threadId]/page.tsx"],"sourcesContent":["\"use client\";\nimport React, { useEffect, useState } from \"react\";\nimport { useParams } from \"next/navigation\";\nimport { Input } from \"@/components/ui/input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { useToast } from \"@/components/ui/toast\";\nimport { AuthAPI, ChatAPI, PharmaciesAPI } from \"@/utils/api\";\n\nexport default function ChatThreadPage() {\n  const { show } = useToast();\n  const params = useParams();\n  const threadId = Number(params?.threadId);\n  const [tenantId, setTenantId] = useState<string | null>(null);\n  const [pharmacies, setPharmacies] = useState<any[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [messages, setMessages] = useState<Array<{id:number; role:string; content:string}>>([]);\n  const [prompt, setPrompt] = useState(\"\");\n  const [error, setError] = useState<string | null>(null);\n  const [streaming, setStreaming] = useState(false);\n\n  async function refresh(tid: string) {\n    setLoading(true);\n    try {\n      const rows = await ChatAPI.listMessages(tid, threadId);\n      setMessages(rows || []);\n      setError(null);\n    } catch (e:any) {\n      setError(e.message || \"Failed to load messages\");\n    } finally { setLoading(false); }\n  }\n\n  useEffect(() => {\n    (async ()=>{\n      try {\n        const me = await AuthAPI.me();\n        const ph = await PharmaciesAPI.list(1, 100);\n        const items = ph?.items || [];\n        setPharmacies(items);\n        const defaultTid = me?.tenant_id || (items[0]?.tenant_id ?? null);\n        if (defaultTid) { setTenantId(defaultTid); await refresh(defaultTid); }\n        else { setError(\"No tenant context\"); setLoading(false); }\n      } catch (e:any) { setError(e.message || \"Failed\"); setLoading(false); }\n    })();\n  }, [threadId]);\n\n  async function send() {\n    if (!tenantId || !prompt.trim()) return;\n    try {\n      const p = prompt.trim();\n      setPrompt(\"\");\n      setStreaming(true);\n      await ChatAPI.sendStream(tenantId, threadId, p, (evt)=>{\n        // Optional: we could add partial UI updates here if backend sent tokens\n        // We stream only lifecycle events and final payload right now\n        if (evt.event === \"final\") {\n          refresh(tenantId);\n          setStreaming(false);\n        }\n      });\n    } catch (e:any) {\n      setStreaming(false);\n      show({ variant: \"destructive\", title: \"Send failed\", description: e.message });\n    }\n  }\n\n  return (\n    <div className=\"space-y-4\">\n      <div className=\"flex items-center justify-between\">\n        <h1 className=\"text-xl font-semibold\">Business Chat</h1>\n      </div>\n      {loading ? (<Skeleton className=\"h-64\" />) : error ? (<div className=\"text-sm text-red-600\">{error}</div>) : (\n        <div className=\"space-y-3\">\n          <div className=\"border rounded p-3 h-[60vh] overflow-auto bg-white\">\n            {messages.map((m)=> (\n              <div key={m.id} className={`mb-3 ${m.role === 'user' ? 'text-right' : 'text-left'}`}>\n                <div className={`inline-block max-w-[80%] p-3 rounded-lg whitespace-pre-wrap ${\n                  m.role === 'user' \n                    ? 'bg-blue-600 text-white' \n                    : 'bg-gray-100 text-gray-900'\n                }`}>\n                  {m.role === 'assistant' ? (() => {\n                    try {\n                      const parsed = JSON.parse(m.content);\n                      return parsed.answer || m.content;\n                    } catch {\n                      return m.content;\n                    }\n                  })() : m.content}\n                </div>\n              </div>\n            ))}\n            {messages.length === 0 && <div className=\"text-sm text-gray-500\">No messages yet.</div>}\n          </div>\n          <div className=\"flex items-center gap-2\">\n            <Input placeholder=\"Type your message\" value={prompt} onChange={(e)=>setPrompt(e.target.value)} onKeyDown={(e)=>{ if (e.key === 'Enter') send(); }} />\n            <Button onClick={send} disabled={!tenantId || !prompt.trim() || streaming}>{streaming ? \"Sending...\" : \"Send\"}</Button>\n            {streaming && <div className=\"text-xs text-gray-500 animate-pulse\">Assistant is typingâ€¦</div>}\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n"],"names":[],"mappings":"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"}